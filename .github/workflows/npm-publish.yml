# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://docs.github.com/en/actions/publishing-packages/publishing-nodejs-packages

# name: Node.js Package

# on:
#   push:
#     branches:
#       - main

# jobs:
#   publish-npm:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v3
#       - uses: actions/setup-node@v3
#         with:
#           node-version: 16
#           registry-url: https://registry.npmjs.org/
#       - run: yarn install
#       - run: yarn build
#       - run: npm publish --access public
#         env:
#           NODE_AUTH_TOKEN: ${{secrets.npm_token}}

name: Node.js Package

on:
  push:
    branches:
      - main
      - develop

jobs:
  publish-npm:
    runs-on: ubuntu-latest

    steps:
      
        uses: actions/checkout@v2
        uses: actions/setup-node@v3
        with:
          node-version: 16
          registry-url: https://registry.npmjs.org/

      - name: Set version match output variable
        id: set-version-match
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            VERSION_MATCH=$(jq -r '.version' package.json | grep -q '^[0-9]+\.[0-9]+\.[0-9]+$' && echo 'true' || echo 'false')
            echo "::set-output name=match::${VERSION_MATCH}"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            VERSION_MATCH=$(jq -r '.version' package.json | grep -q '^[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+\.[0-9]+\.[0-9]+$' && echo 'true' || echo 'false')
            echo "::set-output name=match::${VERSION_MATCH}"
          fi

  publish-condition:
    needs: publish
    runs-on: ubuntu-latest

    steps:
      - name: Display version match output
        run: |
          echo "Version match: ${{ needs.publish.outputs.match }}"

- run: yarn install
- run: yarn build
- run: npm publish --access public
 env:
     NODE_AUTH_TOKEN: ${{secrets.npm_token}}
